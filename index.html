<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Connect 4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.2/normalize.min.css">
    <!--<link rel="stylesheet" href="local/normalize.min.css">-->
    <style type="text/css" media="all">
        #main {
            background-color: blue;
            width: 350px;
            overflow: hidden;
        }

        .item {
            border-radius: 55px;
            background-color: #fff;
            width: 40px;
            height: 40px;
            float: left;
            border: 5px solid blue;
        }

        .item:hover {
            cursor: pointer;
        }

        .item.active {
        }

        .item.red {
            background-color: #ff0000;
        }

        .item.yellow {
            background-color: yellow;
        }

    </style>
</head>
<body>
<div id="main"></div>
<a href="#" class="reset-game">Reset Game</a>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>

<!--<script src="local/jquery.min.js"></script>-->
<!--<script src="local/underscore-min.js"></script>-->
<script type="text/javascript" charset="utf-8">
    (function ( $ ) {
        var connectFour = {
            tableSize : [ 7, 6 ],
            currentPlayer : 'yellow',
            positions : [],

            init : function () {

                // Generate Game board
                this.buildGameBoard();

                // Setup reset game button
                $( '.reset-game' ).on( 'click', function ( e ) {
                    e.preventDefault();
                    connectFour.resetBoard();
                } );
            },
            buildGameBoard : function () {
                _( this.tableSize[ 1 ] ).times( function ( row ) {
                    connectFour.positions[ row ] = [];
                    _( connectFour.tableSize[ 0 ] ).times( function ( col ) {
                        $( '#main' ).append( connectFour.createConnectCircle( col, row ) );
                        connectFour.positions[ row ][ col ] = 0;
                    } );
                } );
            },
            createConnectCircle : function ( col, row ) {
                return $( '<div>' )
                        .addClass( 'item' )
                        .attr( 'data-col', col )
                        .attr( 'data-row', row )
                        .bind( 'click', this.clickHandler );
            },
            clickHandler : function ( event ) {
                event.preventDefault();

                var col = parseInt($( this ).attr( 'data-col' ));

                for ( var row = connectFour.tableSize[ 1 ] - 1; row >= 0; row-- ) {

                    var $slot = $( '[data-col="' + col + '"][data-row="' + row + '"]' );

                    if ( connectFour.positions[ 0 ][ col ] !== 0 ) {
                        console.log( 'invalid move' );
                        break;
                    }
                    if ( connectFour.positions[ row ][ col ] == 0 ) {
                        $slot.addClass( connectFour.currentPlayer );
                        connectFour.positions[ row ][ col ] = connectFour.currentPlayer;

                        connectFour.checkHorizontal( row );
                        connectFour.checkVertical( col );
                        connectFour.checkDiagonal( row, col );

                        connectFour.currentPlayer = connectFour.currentPlayer == 'yellow' ? 'red' : 'yellow';

                        if ( row == 0 ) {
                            connectFour.checkTie();
                        }

                        break;
                    }
                }
            },
            checkHorizontal : function ( row ) {

                // No possible winner if the 4th column is empty
//                if ( connectFour.positions[ row ][ 3 ] !== 0 ) {

                    var count = {
                        'red' : '',
                        'yellow' : '',
                        0 : ''
                    };

                    for ( var col = 0; col < this.tableSize[ 0 ]; col++ ) {

                        count[ connectFour.positions[ row ][ col ] ] += col + ',';

                    }

//                    console.log(count);
                    this.checkObjectForWinner( count );
//                }

            },
            checkVertical : function ( col ) {


                // No possible winner if the 4th column is empty
//                if ( connectFour.positions[ 3 ][ col ] !== 0 ) {

                    var count = {
                        'red' : '',
                        'yellow' : '',
                        0 : ''
                    };

                    for ( var row = 0; row < this.tableSize[ 1 ]; row++ ) {

                        count[ connectFour.positions[ row ][ col ] ] += row + ',';

                    }


//                    console.log(count);
                    this.checkObjectForWinner( count );
//                }

            },
            checkDiagonal : function (row, col) {
                var bounds = 8,
                    topLeft = {
                        'red' : '',
                        'yellow' : '',
                        0 : ''
                    },
                    topRight = {
                        'red' : '',
                        'yellow' : '',
                        0 : ''
                    };

                for(var x = 0; x < this.tableSize[0]; x++) {

                    for(var y = 0; y < this.tableSize[1]; y++) {

                        // Check top left diagonal
                        for (var i = 0; i < bounds; i++) {

                            // Bounds check
                            if(this.positions[x + i] == undefined || this.positions[x + i][y + i] == undefined) {
                                break;
                            }

                            topLeft[ connectFour.positions[ x + i ][ y + i ] ] += ( x + i ) + ',';

                        }

                        this.checkObjectForWinner(topLeft);

                        topLeft = {
                            'red' : '',
                            'yellow' : '',
                            0 : ''
                        };

                        for (var i = 0; i < bounds; i++) {

                            // Bounds check
                            if(this.positions[x - i] == undefined || this.positions[x - i][y + i] == undefined) {
                                break;
                            }

                            topRight[ connectFour.positions[ x + -i ][ y + i ] ] += ( x + -i ) + ',';

                        }

                        this.checkObjectForWinner(topRight);

                        topRight = {
                            'red' : '',
                            'yellow' : '',
                            0 : ''
                        };

                    }

                }

            },

            checkObjectForWinner : function ( obj ) {

                _.each( obj, function ( str, i ) {

                    // Lets get an array to count
                    var pieces = str.split( ',' );

                    // Drop the last element, its the trailing ',' from the string concat
                    pieces.pop();

                    if ( pieces.length >= 4 && (i == 'yellow' || i == 'red') ) {
                        console.log('possible winner');
//                        _(pieces.yellow ).every(function(x) {
//
//                            if(x == lastIndex + 1) {
//                                count++;
//                            }
//                            else {
//                                count = 0;
//                            }
//
//                        });
                    }

                } );

            },
            checkTie : function () {

                var isTie = true;

                _( this.positions ).every( function ( i ) {
                    if ( i.indexOf( 0 ) > -1 ) {
                        isTie = false;
                        return false;
                    }
                } );

                if ( isTie ) {
                    $( 'body' ).addClass( 'tie-game' );
                    this.resetBoard();
                }

            },
            resetBoard : function () {

                $( '#main' )[0].innerHTML = '';

                var $body = $( 'body' );

                $body.removeClass( 'tie-game' );

                connectFour.init();
            }
        };

        connectFour.init();

    })( jQuery );
</script>
</body>
</html>
